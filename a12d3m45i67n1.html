<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanB Music - Advanced Scheduler</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @font-face {
            font-family: 'planb';
            src: url('data:application/octet-stream;base64,T1RUTwAOAIAAAwBgQ0ZGIMIfBUQAAD3gAAb5yERTSUcAAAABAAkOxAAAAAhHU1VCLZKgnAAHN6gAAK5+T1MvMn13UPQAAAFQAAAAYFZPUkfRZ4yIAAfmKAAABChjbWFw1c4mjQAABZQAADgqaGVhZMAtWyYAAADsAAAANmhoZWEGwSgAAAABJAAAACRobXR4Om/30QAH6lAAAJIobWF4cCSKUAAAAAFIAAAABm5hbWUfnyFwAAABsAAAA+Jwb3N0/7gAMgAAPcAAAAAgdmhlYQZPNeoACHx4AAAAJHZtdHg6anN7AAh8nAAAkigAAQAAAAEZmuMf/3BfDzz1AAMD6AAAAAB8JZ3AAAAAAOGiYF7/bP70A...'); 
        }
        :root { --bg-color: #000; --card-bg: #111; --border: #222; --accent: #fff; --text-dim: #888; --today-border: #ff0000; --danger: #ff4d4d; }
        body { background-color: var(--bg-color); color: #fff; font-family: 'planb', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1050px; background: var(--card-bg); border-radius: 24px; padding: 50px; box-shadow: 0 30px 60px rgba(0,0,0,0.8); margin-bottom: 30px; overflow: hidden; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .title-group { display: flex; align-items: center; gap: 0; }
        .editable-title, .today-category, .today-date-text { font-size: 50px; font-weight: 800; letter-spacing: -2px; line-height: 1; }
        .editable-title { margin-right: 15px; }
        .today-date-text { color: var(--accent); margin-right: 10px; }
        .today-category { color: var(--text-dim); }
        .tab-container { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; justify-content: flex-start; }
        .tab { padding: 10px 22px; background: #1a1a1a; border: 1px solid var(--border); border-radius: 50px; cursor: pointer; color: var(--text-dim); font-size: 14px; font-weight: bold; transition: 0.3s; }
        .tab.active { background: #fff; color: #000; border-color: #fff; }
        .month-controller { display: flex; align-items: center; gap: 15px; padding: 20px 0; border-top: 1px solid var(--border); margin-bottom: 25px; width: 100%; }
        .current-month-text { font-size: 36px; font-weight: 800; min-width: 200px; text-align: center; letter-spacing: -1px; }
        .arrow-btn { background: transparent; border: 1px solid var(--border); color: var(--accent); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-group { display: flex; gap: 10px; margin-left: auto; }
        .btn { padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: bold; border: none; }
        .btn-save { background: #fff; color: #000; }
        .btn-img { background: #222; color: #fff; border: 1px solid var(--border); }
        .btn-today { background: #ff0000; color: #fff; border: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: var(--border); border: 1px solid var(--border); width: 100%; }
        .day-header { background: #0a0a0a; color: var(--text-dim); height: 50px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        .day-cell { background: var(--card-bg); min-height: 140px; display: flex; flex-direction: column; cursor: pointer; position: relative; box-sizing: border-box; overflow: hidden; }
        .day-cell.today { 
            border: 4px solid #ff0000 !important; 
            z-index: 10; 
            box-shadow: inset 0 0 10px rgba(255, 0, 0, 0.2), 0 0 15px rgba(255, 0, 0, 0.4); 
            position: relative;
        }
        .day-cell.today .day-num { padding-top: 12px; padding-left: 14px; }
        .day-num { font-size: 18px; color: #666; padding: 10px 12px; font-weight: bold; z-index: 2; width: 100%; box-sizing: border-box; }
        .schedule-container { flex-grow: 1; display: flex; flex-direction: column; z-index: 1; position: relative; }
        .schedule-item { flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; padding: 8px 12px; font-size: 13px; line-height: 1.4; color: #fff; white-space: pre-wrap; word-break: break-all; font-weight: bold; }
        .ice-emoji-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%); font-size: 50px; }
        .notice-area { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); color: var(--text-dim); font-size: 13px; line-height: 1.8; font-weight: bold; }

        .credit-area { width: 100%; max-width: 1050px; text-align: center; color: #666; font-size: 13px; line-height: 1.8; margin-top: 20px; margin-bottom: 50px; }
        .credit-title { font-weight: bold; color: #888; margin-bottom: 8px; }
        .copyright { font-size: 11px; color: #444; margin-top: 15px; }
        .sync-status-bar { display: inline-flex; flex-direction: column; align-items: flex-start; gap: 8px; background: rgba(255,255,255,0.03); padding: 12px 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #222; }
        .sync-item { display: flex; align-items: center; gap: 10px; width: 100%; }
        .sync-label { color: #888; font-weight: bold; font-size: 11px; min-width: 75px; text-align: left; }
        .sync-value { color: #bbb; font-size: 11px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 24px; width: 400px; border: 1px solid var(--border); max-height: 85vh; overflow-y: auto; }
        .list-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .list-item { background: #222; border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; }
        .list-item-btn { flex: 1; padding: 15px; text-align: left; background: none; border: none; color: #fff; cursor: pointer; display: flex; flex-direction: column; gap: 4px; font-weight: bold; }
        .del-btn-small { padding: 15px; color: var(--danger); background: none; border: none; cursor: pointer; font-size: 18px; border-left: 1px solid var(--border); }
        .add-btn-large { width: 100%; padding: 15px; background: #333; color: #fff; border: 1px dashed #555; border-radius: 12px; cursor: pointer; margin-bottom: 10px; font-weight: bold; }
        .input-step { display: none; }
        select, textarea { width: 100%; background: #000; color: #fff; border: 1px solid var(--border); padding: 12px; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; font-family: inherit; }
        textarea { height: 100px; resize: none; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btns button { flex: 1; padding: 14px; border-radius: 10px; cursor: pointer; border: none; font-weight: bold; }
        .save-modal { background: #fff; color: #000; }
        .close-modal { background: #333; color: #fff; }
        .delete-detail-btn { background: var(--danger) !important; color: #fff !important; }

        .exporting .no-export { display: none !important; }
        .exporting .vod-indicator { display: none !important; }
        /* VOD ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .day-num { position: relative; }
        .vod-indicator {
            position: absolute; top: 0; right: 0;
            width: 0; height: 0;
            border-style: solid;
            border-width: 0 14px 14px 0;
            border-color: transparent currentColor transparent transparent;
            z-index: 3;
        }
        .day-num.has-vod { cursor: pointer; }
        .day-num.has-vod:hover { opacity: 0.75; }

        .vod-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .vod-section-title {
            font-size: 12px; color: #888; font-weight: bold; margin-bottom: 10px;
        }
        .vod-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .vod-item {
            background: #1a1a1a; border: 1px solid #333; border-radius: 10px;
            display: flex; align-items: center; overflow: hidden;
        }
        .vod-item-label {
            flex: 1; padding: 10px 14px; font-size: 12px; color: #bbb;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: pointer; text-align: left; background: none; border: none;
            font-family: inherit; font-weight: bold;
        }
        .vod-item-label:hover { color: #fff; }
        .vod-del-btn {
            padding: 10px 14px; color: var(--danger); background: none;
            border: none; border-left: 1px solid #333; cursor: pointer; font-size: 14px;
        }
        .vod-add-btn {
            width: 100%; padding: 12px; background: #1a1a1a; color: #888;
            border: 1px dashed #444; border-radius: 10px; cursor: pointer;
            font-weight: bold; font-size: 13px; font-family: inherit;
        }
        .vod-add-btn:hover { color: #fff; border-color: #666; }


    </style>
</head>
<body>

<div class="container" id="capture-area">
    <div class="header-top">
        <div class="title-group">
            <div class="editable-title" id="main-title">ë¹•ì–´ |</div>
            <div class="today-date-text" id="top-date-display"></div>
            <div class="today-category" id="top-today-cat">ë±…ì˜¨ ë¯¸ì •</div>
        </div>
    </div>

    <div class="tab-container no-export">
        <div class="tab active" onclick="switchTab('ë¹•ì–´', this)">ë¹•ì–´</div>
        <div class="tab" onclick="switchTab('í•œì„¸ê¸´', this)">í•œì„¸ê¸´</div>
        <div class="tab" onclick="switchTab('ë‚˜ë¹„', this)">ë‚˜ë¹„</div>
        <div class="tab" onclick="switchTab('ì†¡ë°¤', this)">ì†¡ë°¤</div>
        <div class="tab" onclick="switchTab('í¬ì•™í¬', this)">í¬ì•™í¬</div>
    </div>

    <div class="month-controller no-export">
        <button class="arrow-btn" onclick="changeMonth(-1)"><span>ã€ˆ</span></button>
        <div class="current-month-text" id="monthDisplay"></div>
        <button class="arrow-btn" onclick="changeMonth(1)"><span>ã€‰</span></button>
        <div class="btn-group">
            <button class="btn btn-save" onclick="saveDataToServer()">UPDATE</button>
            <button class="btn btn-img" onclick="exportImage()">IMAGE</button>
            <button class="btn btn-today" onclick="goToday()">TODAY</button>
        </div>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>

    <div class="notice-area">
        * ìì„¸í•œ ì¼ì •ì€ ë°©ì†¡ ê³µì§€ ì°¸ê³  <br>
        * ë‚ ì§œ ê¸°ë¡ ê¸°ì¤€ì€ ë‹¹ì¼ ì˜¤ì „ 6:00 ~ ë‹¤ìŒë‚  ì˜¤ì „ 5:59 ë±…ì˜¨ ê¸°ì¤€ì…ë‹ˆë‹¤.
    </div>
</div>

<div class="credit-area no-export">
    <div class="credit-title">[ í”Œëœë¹„ ìº˜ë¦°ë”íŒ€ ]</div>
    <div>ì œì‘ì - ì¹´í”¼ë°”ë¼, ë¦¬í¬, ê¹€ë¶€ë™, ì•ˆì¦ˆ, ì´ì›Œë¦¬</div>
    <div>ì›¹ ì œì‘ - ì¹´í”¼ë°”ë¼</div>
    <div class="copyright">
        í•´ë‹¹ ì œì‘ë¬¼ì˜ ëª¨ë“  ê¶Œë¦¬ëŠ” ì›ì‘ì(ì¹´í”¼ë°”ë¼)ì—ê²Œ ìˆìœ¼ë©°, <br>
        í”Œëœë¹„ ë®¤ì§ì˜ ë¹„ê³µì‹ íŒ¬ ì œì‘ë¬¼ì…ë‹ˆë‹¤. <br>
        ë²„ê·¸ ë° ìˆ˜ì •ì‚¬í•­ ì œë³´ - working.kapibara@gmail.com
    </div>
    <div style="margin-top: 20px; margin-bottom: 20px;">
        <img src="logo.png" alt="PlanB Logo" style="width: 120px; height: auto; opacity: 0.8;">
    </div>
    <div class="sync-status-bar">
        <div class="sync-item"><span class="sync-label">DATA SYNC</span><span id="last-db-update" class="sync-value">ëŒ€ê¸° ì¤‘...</span></div>
        <div class="sync-item"><span class="sync-label">BUILD</span><span id="last-github-update" class="sync-value">í™•ì¸ ì¤‘...</span></div>
    </div>
</div>

<div class="modal" id="scheduleModal">
    <div class="modal-content">
        <h3 id="modalDateTitle" style="text-align:center; margin-top:0;">ì¼ì • ê´€ë¦¬</h3>
        <div id="step-list">
            <div id="schedule-list-area" class="list-group"></div>
            <button class="add-btn-large" onclick="goToInput('add')">+ ìƒˆë¡œìš´ ì¼ì • ì¶”ê°€</button>

            <!-- VOD ì„¹ì…˜ -->
            <div class="vod-section">
                <div class="vod-section-title">ğŸ“º ë‹¤ì‹œë³´ê¸° VOD ë§í¬</div>
                <div id="vod-list-area" class="vod-list"></div>
                <!-- ì¸ë¼ì¸ ì…ë ¥ íŒ¨ë„ (ë³„ë„ ëª¨ë‹¬ ì—†ì´) -->
                <div id="vod-inline-panel" style="display:none; background:#0d0d0d; border:1px solid #333; border-radius:12px; padding:14px; margin-top:8px;">
                    <div style="font-size:12px; color:#888; font-weight:bold; margin-bottom:10px;" id="vod-panel-title">VOD ë§í¬ ì¶”ê°€</div>
                    <input type="text" id="vodLabelInput" placeholder="ì œëª© (ì˜ˆ: 1ë¶€, 2ë¶€ / ë¹„ìš°ë©´ ìë™ì„¤ì •)" style="width:100%; background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:8px; box-sizing:border-box; font-family:inherit; font-size:12px; margin-bottom:8px; display:block;">
                    <input type="text" id="vodUrlInput" placeholder="https://ch.sooplive.co.kr/..." style="width:100%; background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:8px; box-sizing:border-box; font-family:inherit; font-size:12px; margin-bottom:4px; display:block;">
                    <div style="font-size:10px; color:#444; margin-bottom:10px; line-height:1.5;">â€» ìë™ ìƒì„±ëœ ë§í¬ì´ë©°, ìˆ˜ì • ì‹œ ì´í›„ ìë™ ê°±ì‹ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                    <div style="display:flex; gap:8px;">
                        <button id="vod-panel-del-btn" onclick="deleteCurrentVod()" style="display:none; flex:1; padding:10px; background:#ff4d4d; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-family:inherit; font-size:13px;">ì‚­ì œ</button>
                        <button onclick="confirmVod()" style="flex:2; padding:10px; background:#fff; color:#000; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-family:inherit; font-size:13px;">ì €ì¥</button>
                        <button onclick="closeVodPanel()" style="flex:1; padding:10px; background:#333; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-family:inherit; font-size:13px;">ì·¨ì†Œ</button>
                    </div>
                </div>
                <button class="vod-add-btn" id="vod-add-btn" onclick="openVodPanel(-1)">+ VOD ë§í¬ ì¶”ê°€</button>
            </div>

            <button class="close-modal" style="width:100%; margin-top:15px;" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
        <div id="step-input" class="input-step">
            <select id="modalCategory" onchange="updateSelectColor(this)">
                <option value="ë±…ì˜¨ ë¯¸ì •" style="color: #ffffff;">â— ë±…ì˜¨ ë¯¸ì •</option>
                <option value="í‰ë±…" style="color: #31982f;">â— í‰ë±…</option>
                <option value="ì§§ë±…/ë¹„ë²ˆ/êµ¬í”Œ" style="color: #0070bf;">â— ì§§ë±…/ë¹„ë²ˆ/êµ¬í”Œ</option>
                <option value="í•©ë°©/ì»¨í…ì¸ " style="color: #d98516;">â— í•©ë°©/ì»¨í…ì¸ </option>
                <option value="í”Œëœë¹„ì¼ì •" style="color: #702ea0;">â— í”Œëœë¹„ì¼ì •</option>
                <option value="ì¤‘ìš”ì¼ì •" style="color: #d63f6f;">â— ì¤‘ìš”ì¼ì •</option>
                <option value="ë¹™í•˜ê¸°" style="color: #87CEEB;">â— ë¹™í•˜ê¸°</option>
                <option value="íœ´ë±…" style="color: #404040;">â— íœ´ë±…</option>
                <option value="ì—°ìŠµìƒì¼ì •" style="color: #ffd966;">â— ì—°ìŠµìƒì¼ì •</option>
            </select>
            <textarea id="modalText" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <div class="modal-btns">
                <button id="detail-del-btn" class="delete-detail-btn" onclick="deleteCurrentSchedule()">ì‚­ì œ</button>
                <button class="save-modal" onclick="confirmSchedule()">ì ìš©</button>
                <button class="close-modal" onclick="backToList()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    const firebaseConfig = {
        apiKey: "AIzaSyDjxU-1ktf7WMtrGMTWjPMKkaihNU5_MLQ",
        authDomain: "planb-calender.firebaseapp.com",
        databaseURL: "https://planb-calender-default-rtdb.firebaseio.com",
        projectId: "planb-calender",
        storageBucket: "planb-calender.firebasestorage.app",
        messagingSenderId: "990002341913",
        appId: "1:990002341913:web:9fb6b9875c89a012742288"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const today = new Date();
    let currentYear = today.getFullYear(), currentMonth = today.getMonth() + 1, currentMember = 'ë¹•ì–´', monthData = {}, vodData = {}, selectedDateKey = "", modalMode = "add", editIndex = -1, vodEditIndex = -1;
    
    const categoryColors = { "í‰ë±…": "#31982f", "ì§§ë±…/ë¹„ë²ˆ/êµ¬í”Œ": "#0070bf", "í•©ë°©/ì»¨í…ì¸ ": "#d98516", "í”Œëœë¹„ì¼ì •": "#702ea0", "ì¤‘ìš”ì¼ì •": "#d63f6f", "ë¹™í•˜ê¸°": "#87CEEB", "íœ´ë±…": "#404040", "ì—°ìŠµìƒì¼ì •": "#ffd966", "ë±…ì˜¨ ë¯¸ì •": "#ffffff" };
    const memberEmojis = { 'ë¹•ì–´': 'ğŸ˜', 'í•œì„¸ê¸´': 'ğŸ’™', 'ë‚˜ë¹„': 'ğŸ’›', 'ì†¡ë°¤': 'ğŸ’œ', 'í¬ì•™í¬': 'ğŸ¤' };

    function refreshSyncTime() {
        const now = new Date();
        document.getElementById('last-db-update').textContent = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    async function fetchGitHubBuild() {
        try {
            const res = await fetch(`https://api.github.com/repos/workingkapibara/calender/commits/main`);
            if (res.ok) {
                const data = await res.json();
                const d = new Date(data.commit.author.date);
                document.getElementById('last-github-update').textContent = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')} - ${data.commit.message.split('\n')[0]}`;
            }
        } catch(e) { document.getElementById('last-github-update').textContent = "ì—°ë™ ì‹¤íŒ¨"; }
    }

    function pad2(n) { return String(n).padStart(2, '0'); }
    function makeDateKey(y, m, d) { return `${y}-${pad2(m)}-${pad2(d)}`; }
    function normalizeKey(key) { const p = String(key).split('-'); return `${p[0]}-${pad2(p[1])}-${pad2(p[2])}`; }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        document.getElementById('monthDisplay').textContent = `${currentYear}.${pad2(currentMonth)}`;
        ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].forEach(d => grid.appendChild(Object.assign(document.createElement('div'), {className:'day-header', textContent:d})));
        
        const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
        const lastDate = new Date(currentYear, currentMonth, 0).getDate();
        
        for (let i = 0; i < firstDay; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:'day-cell'}));
        
        for (let date = 1; date <= lastDate; date++) {
            const key = makeDateKey(currentYear, currentMonth, date);
            const cell = document.createElement('div'); cell.className = 'day-cell';
            const num = document.createElement('div'); num.className = 'day-num'; num.textContent = date;
            const container = document.createElement('div'); container.className = 'schedule-container';
            const schedules = monthData[key] || [];
            
            if (schedules.length > 0) {
                const firstSchedule = schedules[0];
                if (firstSchedule.cat === "ë¹™í•˜ê¸°") {
                    cell.style.backgroundColor = "#404040";
                    num.style.color = "#fff";
                    num.style.backgroundColor = "transparent";
                    const ice = document.createElement('div');
                    ice.className = 'ice-emoji-box';
                    ice.textContent = 'ğŸ§Š';
                    container.appendChild(ice);
                } else {
                    if (firstSchedule.cat !== "ë±…ì˜¨ ë¯¸ì •") {
                        num.style.backgroundColor = categoryColors[firstSchedule.cat];
                        num.style.color = firstSchedule.cat === "ì—°ìŠµìƒì¼ì •" ? "#333" : "#fff";
                    } else {
                        // ë±…ì˜¨ ë¯¸ì •ì¼ ë•Œì˜ ì²˜ë¦¬
                        num.style.color = "#666";
                        num.style.backgroundColor = "transparent";
                    }

                    schedules.forEach((s, idx) => {
                        const div = document.createElement('div'); div.className = 'schedule-item';
                        if (s.cat !== "ë±…ì˜¨ ë¯¸ì •") {
                            div.style.backgroundColor = categoryColors[s.cat];
                            if (s.cat === "ì—°ìŠµìƒì¼ì •") div.style.color = "#333";
                        } else {
                            // ë±…ì˜¨ ë¯¸ì • ì•„ì´í…œ ìŠ¤íƒ€ì¼
                            div.style.color = "#fff";
                            div.style.backgroundColor = "transparent";
                        }
                        if(idx > 0) div.style.borderTop = "1px solid rgba(255,255,255,0.1)";
                        div.textContent = s.text;
                        container.appendChild(div);
                    });
                }
            } else {
                num.style.color = '#666';
                num.style.backgroundColor = "transparent";
            }

            if (currentYear === today.getFullYear() && currentMonth === (today.getMonth()+1) && date === today.getDate()) {
                cell.classList.add('today');
            }

            // VOD ì•„ì´ì½˜ í‘œì‹œ ì¡°ê±´:
            // 1. ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œë§Œ (ì˜¤ëŠ˜ í¬í•¨ X)
            // 2. íœ´ë±… ì¹´í…Œê³ ë¦¬ë©´ ìˆ˜ë™ ì €ì¥ëœ VOD ìˆì„ ë•Œë§Œ
            const cellDate = new Date(currentYear, currentMonth - 1, date);
            const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const isPast = cellDate < todayMidnight;
            const isHyubang = schedules.length > 0 && schedules[0].cat === 'íœ´ë±…';
            const isNoBang = schedules.length === 0 || schedules[0].cat === 'ë±…ì˜¨ ë¯¸ì •' || schedules[0].cat === 'ë¹™í•˜ê¸°';
            const hasCustomVod = (vodData[key] || []).length > 0;
            const showVodIcon = isPast && !isNoBang && (!isHyubang || hasCustomVod);

            cell.onclick = () => openModal(key, date);
            cell.append(num, container);

            if (showVodIcon) {
                num.classList.add('has-vod');
                const vodIcon = document.createElement('span');
                vodIcon.className = 'vod-indicator';
                vodIcon.textContent = '';
                // ì‚¼ê°í˜• ìƒ‰ìƒ = ë‚ ì§œ ìˆ«ì ê¸€ì”¨ ìƒ‰
                vodIcon.style.color = num.style.color || '#666';
                cell.appendChild(vodIcon);
                num.style.cursor = 'pointer';
                num.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openVodFromNum(key, date);
                });
                vodIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openVodFromNum(key, date);
                });
            }

            grid.appendChild(cell);
        }
    }

    function updateTopUI() {
        const todayKey = makeDateKey(today.getFullYear(), today.getMonth() + 1, today.getDate());
        const s = monthData[todayKey] ? monthData[todayKey][0] : null;
        
        const elCat = document.getElementById('top-today-cat');
        const elDate = document.getElementById('top-date-display');
        elDate.textContent = `${today.getMonth()+1}/${today.getDate()} -`;
        
        if (s) { 
            const emoji = (s.cat === "ë¹™í•˜ê¸°") ? "ğŸ§Š" : (memberEmojis[currentMember] || '');
            elCat.textContent = `${s.cat} ${emoji}`; 
            
            if (s.cat === "ë±…ì˜¨ ë¯¸ì •") {
                elCat.style.color = "var(--text-dim)";
            } else {
                elCat.style.color = categoryColors[s.cat];
            }
        } else { 
            elCat.textContent = "ë±…ì˜¨ ë¯¸ì •"; 
            elCat.style.color = "var(--text-dim)"; 
        }
    }

    function goToday() {
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
        loadData();
    }

    function openModal(key, date) {
        selectedDateKey = key;
        document.getElementById('modalDateTitle').textContent = `${currentMonth}ì›” ${date}ì¼ ì¼ì • ê´€ë¦¬`;
        renderVodList();
        if (!(monthData[key] || []).length) goToInput('add');
        else { showScheduleList(); document.getElementById('scheduleModal').style.display = 'flex'; }
    }

    function openVodFromNum(key, date) {
        // ë‚ ì§œ ìˆ«ì í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê³  VOD ì„¹ì…˜ ë°”ë¡œ ë³´ì—¬ì£¼ê¸°
        selectedDateKey = key;
        document.getElementById('modalDateTitle').textContent = `${currentMonth}ì›” ${date}ì¼ ì¼ì • ê´€ë¦¬`;
        renderVodList();
        showScheduleList();
        document.getElementById('scheduleModal').style.display = 'flex';
        // VOD ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        setTimeout(() => {
            document.querySelector('.vod-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }

    // ë©¤ë²„ë³„ ìˆ² ì±„ë„ ID
    const memberChannelIds = {
        'ë¹•ì–´': 'bver99',
        'í•œì„¸ê¸´': 'rose0957',
        'ë‚˜ë¹„': 'navixx',
        'ì†¡ë°¤': 's07o24',
        'í¬ì•™í¬': '9wang2'
    };

    // ë‚ ì§œ í‚¤(YYYY-MM-DD)ë¡œ ìë™ VOD ë§í¬ ìƒì„±
    function makeAutoVodUrl(member, dateKey) {
        const id = memberChannelIds[member];
        if (!id || !dateKey) return '';
        const d = dateKey.replace(/-/g, ''); // "2026-02-23" -> "20260223"
        return `https://www.sooplive.co.kr/station/${id}/vod?keyword=&period=directInput&startDate=${d}&endDate=${d}`;
    }

    function renderVodList() {
        const vods = vodData[selectedDateKey] || [];
        const area = document.getElementById('vod-list-area');
        const autoUrl = makeAutoVodUrl(currentMember, selectedDateKey);

        if (vods.length === 0) {
            // ì €ì¥ëœ VOD ì—†ìŒ â†’ ìë™ ë§í¬ë¥¼ ë¯¸ë¦¬ë³´ê¸°ë¡œ í‘œì‹œ (ì €ì¥ ì•ˆ ëœ ìƒíƒœ)
            area.innerHTML = `
                <div class="vod-item" style="opacity:0.6; border-style:dashed;">
                    <button class="vod-item-label" onclick="openVodPanel(-1)" title="${autoUrl}" style="font-style:italic;">
                        ğŸ”— ìë™ ë§í¬ (ì €ì¥ ì•ˆ ë¨) â€” í´ë¦­í•˜ì—¬ ì €ì¥
                    </button>
                </div>`;
        } else {
            area.innerHTML = vods.map((v, i) => `
                <div class="vod-item">
                    <button class="vod-item-label" onclick="openVodPanel(${i})" title="${v.url}">
                        ğŸ”— ${v.label || 'ë°©ì†¡êµ­ VOD ëª©ë¡'}${v.isCustom ? '' : ' <span style="font-size:9px;color:#aaa;">ìë™</span>'}
                    </button>
                    <button class="vod-del-btn" onclick="deleteVod(${i})">âœ•</button>
                </div>`).join('');
        }
        closeVodPanel();
    }

    function openVodPanel(editIdx) {
        vodEditIndex = editIdx;
        const isEdit = editIdx >= 0;
        document.getElementById('vod-panel-title').textContent = isEdit ? 'VOD ë§í¬ ìˆ˜ì •' : 'VOD ë§í¬ ì¶”ê°€';
        document.getElementById('vod-panel-del-btn').style.display = isEdit ? 'inline-block' : 'none';

        if (isEdit) {
            const v = vodData[selectedDateKey][editIdx];
            document.getElementById('vodLabelInput').value = v.label || '';
            document.getElementById('vodUrlInput').value = v.url || '';
        } else {
            document.getElementById('vodLabelInput').value = 'ë°©ì†¡êµ­ VOD ëª©ë¡';
            // ìë™ ë§í¬ ìƒì„±
            document.getElementById('vodUrlInput').value = makeAutoVodUrl(currentMember, selectedDateKey);
        }
        document.getElementById('vod-inline-panel').style.display = 'block';
        document.getElementById('vod-add-btn').style.display = 'none';
    }

    function closeVodPanel() {
        document.getElementById('vod-inline-panel').style.display = 'none';
        document.getElementById('vod-add-btn').style.display = 'block';
    }

    function confirmVod() {
        const label = document.getElementById('vodLabelInput').value.trim();
        const url = document.getElementById('vodUrlInput').value.trim();
        if (!url) { alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        if (!vodData[selectedDateKey]) vodData[selectedDateKey] = [];

        // ìë™ ë§í¬ì™€ ë‹¤ë¥´ë©´ isCustom = true
        const autoUrl = makeAutoVodUrl(currentMember, selectedDateKey);
        const isCustom = url !== autoUrl;
        const entry = { label: label || 'ë°©ì†¡êµ­ VOD ëª©ë¡', url, isCustom };

        if (vodEditIndex >= 0) vodData[selectedDateKey][vodEditIndex] = entry;
        else vodData[selectedDateKey].push(entry);

        renderVodList();
        renderCalendar();
        saveVodToServer();
    }

    function deleteVod(i) {
        if (confirm('VOD ë§í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            vodData[selectedDateKey].splice(i, 1);
            if (!vodData[selectedDateKey].length) delete vodData[selectedDateKey];
            renderVodList();
            renderCalendar();
            saveVodToServer();
        }
    }

    function deleteCurrentVod() {
        deleteVod(vodEditIndex);
        closeVodPanel();
    }

    function saveVodToServer() {
        db.ref(`vod/${currentMember}`).set(vodData).then(() => refreshSyncTime());
    }

    function showScheduleList() {
        const area = document.getElementById('schedule-list-area');
        area.innerHTML = (monthData[selectedDateKey] || []).map((s, i) => `
            <div class="list-item">
                <button class="list-item-btn" onclick="goToInput('edit', ${i})">
                    <strong style="color:${categoryColors[s.cat]}">${s.cat}</strong><span>${s.text}</span>
                </button>
                <button class="del-btn-small" onclick="deleteFromList(${i})">âœ•</button>
            </div>`).join('');
        renderVodList();
        document.getElementById('step-list').style.display = 'block';
        document.getElementById('step-input').style.display = 'none';
    }

    function goToInput(mode, idx = -1) {
        modalMode = mode; editIndex = idx;
        document.getElementById('step-list').style.display = 'none';
        document.getElementById('step-input').style.display = 'block';
        const c = document.getElementById('modalCategory'), t = document.getElementById('modalText');
        if (mode === 'edit') { const d = monthData[selectedDateKey][idx]; c.value = d.cat; t.value = d.text; }
        else { c.value = "ë±…ì˜¨ ë¯¸ì •"; t.value = ""; }
        updateSelectColor(c);
        document.getElementById('scheduleModal').style.display = 'flex';
    }

    function confirmSchedule() {
        const cat = document.getElementById('modalCategory').value, text = document.getElementById('modalText').value;
        if (!monthData[selectedDateKey]) monthData[selectedDateKey] = [];
        if (modalMode === 'add') monthData[selectedDateKey].push({cat, text});
        else monthData[selectedDateKey][editIndex] = {cat, text};
        renderCalendar(); updateTopUI(); closeModal(); autoSaveToServer();
    }

    function deleteFromList(i) {
        if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            monthData[selectedDateKey].splice(i, 1);
            if(!monthData[selectedDateKey].length) delete monthData[selectedDateKey];
            renderCalendar(); updateTopUI(); if(!monthData[selectedDateKey]) closeModal(); else showScheduleList();
            autoSaveToServer();
        }
    }

    function deleteCurrentSchedule() { deleteFromList(editIndex); }
    function autoSaveToServer(m = false) { db.ref(`monthly/${currentMember}`).set(monthData).then(() => { refreshSyncTime(); if(m) alert('ì €ì¥!'); }); }
    function saveDataToServer() { autoSaveToServer(true); }
    function updateSelectColor(el) { el.style.color = el.options[el.selectedIndex].style.color; }
    function closeModal() { document.getElementById('scheduleModal').style.display = 'none'; }
    function backToList() { if(!monthData[selectedDateKey]) closeModal(); else showScheduleList(); }
    
    function switchTab(n, el) { 
        currentMember = n; 
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); 
        el.classList.add('active'); 
        document.getElementById('main-title').innerText = n + " |"; 
        loadData(); 
    }

    function loadData() { 
        db.ref(`monthly/${currentMember}`).once('value', s => { 
            const raw = s.val() || {}; 
            monthData = {}; 
            Object.entries(raw).forEach(([k, v]) => { 
                monthData[normalizeKey(k)] = Array.isArray(v) ? v : [v]; 
            });
            // VOD ë°ì´í„°ë„ í•¨ê»˜ ë¡œë“œ
            db.ref(`vod/${currentMember}`).once('value', vs => {
                const rawVod = vs.val() || {};
                vodData = {};
                Object.entries(rawVod).forEach(([k, v]) => {
                    vodData[normalizeKey(k)] = Array.isArray(v) ? v : [v];
                });
                renderCalendar(); 
                updateTopUI();
            });
        }); 
    }

    function changeMonth(d) { currentMonth += d; if (currentMonth > 12) { currentMonth = 1; currentYear++; } else if (currentMonth < 1) { currentMonth = 12; currentYear--; } loadData(); }

    async function exportImage() {
        document.body.classList.add('exporting');
        const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 2, backgroundColor: null, useCORS: true });
        const link = document.createElement('a');
        const pad = n => String(n).padStart(2,'0');
        const now = new Date();
        link.download = `PlanB_${currentMember}_${currentYear}${pad(currentMonth)}_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}.png`;
        link.href = canvas.toDataURL();
        link.click();
        document.body.classList.remove('exporting');
    }

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    loadData();
    fetchGitHubBuild();
</script>
</body>
</html>



